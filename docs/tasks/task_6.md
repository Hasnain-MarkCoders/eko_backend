# Task 6: EKO Bot Chat Functionality Implementation

## üéØ **Objective**
Implement the core chat functionality for the EKO psychological assistant bot, including chat management APIs and OpenAI integration for intelligent chat name generation.

## üìã **Project Context**

### **EKO Mobile Application Overview**
The EKO mobile application is a conversational psychological assistant similar to ChatGPT, designed to provide supportive and intelligent responses to users. The backend is part of a fullstack project with:

- **Frontend**: React Native with Greensock animations
- **Backend**: Python FastAPI (this project)
- **Authentication**: Firebase
- **Database**: MongoDB
- **AI Integration**: OpenAI ChatGPT API

### **Bot Identity**
- **Name**: EKO
- **Purpose**: Conversational psychological assistant
- **Interaction Style**: Similar to ChatGPT with supportive responses

## üöÄ **Phase 1: Core Chat APIs (Current Focus)**

### **Required Endpoints**
1. **Create New Chat** - `POST /api/chat/create`
2. **Delete Specific Chat** - `DELETE /api/chat/{chat_id}`
3. **Delete All User Chats** - `DELETE /api/chat/all`

### **Future Endpoints (Phase 2)**
4. **Fetch User Chats** - `GET /api/chat/list`
5. **Get Chat History** - `GET /api/chat/{chat_id}/history`

## üèóÔ∏è **Implementation Plan**

### **Step 1: Database Schema Design**

#### **Chat Collection Structure**
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId", // Reference to users collection
  "name": "string", // Auto-generated by LLM or user-defined
  "isAutoNamed": "boolean", // True if name was generated by LLM
  "status": "string", // "active", "archived", "deleted"
  "createdAt": "datetime",
  "updatedAt": "datetime",
  "lastMessageAt": "datetime", // For sorting by recent activity
  "messageCount": "number", // Total messages in chat
  "isDeleted": "boolean" // Soft delete flag
}
```

#### **Message Collection Structure** (Future)
```json
{
  "_id": "ObjectId",
  "chatId": "ObjectId", // Reference to chats collection
  "userId": "ObjectId", // Reference to users collection
  "role": "string", // "user", "assistant", "system"
  "content": "string", // Message content
  "timestamp": "datetime",
  "isDeleted": "boolean"
}
```

### **Step 2: Model Implementation**

#### **Chat Model** (`models/chat.py`)
- `ChatModel` - Database model
- `ChatResponse` - API response model
- `CreateChatRequest` - Request validation
- `DeleteChatRequest` - Request validation

### **Step 3: Controller Implementation**

#### **Chat Controller** (`controllers/chat_controller.py`)
- `create_chat()` - Create new chat with auto-generated name
- `delete_chat()` - Delete specific chat (soft delete)
- `delete_all_chats()` - Delete all user chats (soft delete)
- `generate_chat_name()` - OpenAI integration for name generation

### **Step 4: Route Implementation**

#### **Chat Routes** (`routes/chat.py`)
- `POST /api/chat/create` - Create new chat
- `DELETE /api/chat/{chat_id}` - Delete specific chat
- `DELETE /api/chat/all` - Delete all user chats

### **Step 5: OpenAI Integration**

#### **OpenAI Service** (`services/openai.py`)
- Chat name generation using ChatGPT API
- Fallback to default naming if API fails
- Environment variable configuration

## üîß **Technical Requirements**

### **Dependencies**
- Add `openai` package to `requirements.txt`
- Environment variable: `OPENAI_API_KEY`

### **Database Indexes**
```javascript
// Chats collection indexes
db.chats.createIndex({ "userId": 1, "isDeleted": 1 })
db.chats.createIndex({ "userId": 1, "lastMessageAt": -1 })
db.chats.createIndex({ "status": 1 })
```

### **Authentication**
- All endpoints require JWT authentication
- Extract `user_id` from JWT token
- Validate user exists and is active

### **Error Handling**
- Standardized error responses using existing error handler
- Multilingual support (English/French)
- Proper HTTP status codes

## üìä **API Specifications**

### **1. Create New Chat**
```http
POST /api/chat/create
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "name": "optional_custom_name" // If not provided, will be auto-generated
}
```

**Response:**
```json
{
  "success": true,
  "message": "Chat created successfully",
  "data": {
    "chatId": "string",
    "name": "string",
    "isAutoNamed": boolean,
    "createdAt": "datetime",
    "messageCount": 0
  }
}
```

### **2. Delete Specific Chat**
```http
DELETE /api/chat/{chat_id}
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "Chat deleted successfully",
  "data": {
    "chatId": "string",
    "deletedAt": "datetime"
  }
}
```

### **3. Delete All User Chats**
```http
DELETE /api/chat/all
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "All chats deleted successfully",
  "data": {
    "deletedCount": number,
    "deletedAt": "datetime"
  }
}
```

## üé® **Chat Name Generation Strategy**

### **Auto-Generation Logic**
1. **User provides custom name**: Use provided name, set `isAutoNamed: false`
2. **No name provided**: Generate using OpenAI with context:
   - User's language preference
   - Current timestamp
   - Generic psychological assistant context

### **OpenAI Prompt Template**
```
Generate a short, friendly chat session name for a psychological assistant app. 
The user is starting a new conversation. 
Language: {user_language}
Context: Psychological support and guidance
Format: 2-4 words, encouraging and welcoming
Examples: "New Journey", "Fresh Start", "Let's Talk", "New Beginning"
```

### **Fallback Strategy**
If OpenAI fails:
- Use timestamp-based name: "Chat - {date}"
- Set `isAutoNamed: false` to indicate fallback

## üîó **Integration Points**

### **Existing Systems**
- **Authentication**: Firebase + JWT middleware
- **Database**: MongoDB with existing patterns
- **Error Handling**: Standardized error responses
- **Localization**: English/French support
- **Docker**: All development in Docker containers

### **Future Integrations**
- **Message Storage**: When implementing chat history
- **Real-time Updates**: WebSocket integration
- **Voice Interface**: Audio message processing
- **Analytics**: Chat usage tracking

## üìù **Implementation Checklist**

### **Phase 1 (Current)**
- [ ] Create chat model and schemas
- [ ] Implement chat controller with 3 core methods
- [ ] Create chat routes and integrate with app
- [ ] Add OpenAI service for name generation
- [ ] Update database.py with chat collection
- [ ] Add required dependencies
- [ ] Test all endpoints

### **Phase 2 (Future)**
- [ ] Implement fetch user chats endpoint
- [ ] Implement get chat history endpoint
- [ ] Add message model and storage
- [ ] Implement real-time chat functionality
- [ ] Add chat search and filtering
- [ ] Implement chat archiving

## üéØ **Success Criteria**

### **Phase 1 Complete When:**
- ‚úÖ All 3 core chat APIs working
- ‚úÖ OpenAI integration functional
- ‚úÖ Proper error handling and validation
- ‚úÖ Database indexes created
- ‚úÖ Authentication working
- ‚úÖ Multilingual support
- ‚úÖ Docker deployment ready

### **Testing Requirements**
- Unit tests for all controller methods
- Integration tests for API endpoints
- Error scenario testing
- OpenAI fallback testing
- Authentication testing

## üìö **Related Files**

### **New Files to Create**
- `models/chat.py` - Chat data models
- `controllers/chat_controller.py` - Chat business logic
- `routes/chat.py` - Chat API routes
- `services/openai.py` - OpenAI integration

### **Files to Modify**
- `app.py` - Include chat router
- `database.py` - Add chat collection
- `requirements.txt` - Add OpenAI dependency
- `locales/en.json` - Add chat messages
- `locales/fr.json` - Add French chat messages

---

**Status**: Ready for implementation
**Priority**: High
**Estimated Time**: 4-6 hours
**Dependencies**: OpenAI API key, existing auth system
