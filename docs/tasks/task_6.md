# Task 6: EKO Bot Chat Functionality Implementation

## üéØ **Objective**
Implement the core chat functionality for the EKO psychological assistant bot, including chat management APIs and OpenAI integration for intelligent chat name generation.

## üìã **Project Context**

### **EKO Mobile Application Overview**
The EKO mobile application is a conversational psychological assistant similar to ChatGPT, designed to provide supportive and intelligent responses to users. The backend is part of a fullstack project with:

- **Frontend**: React Native with Greensock animations
- **Backend**: Python FastAPI (this project)
- **Authentication**: Firebase
- **Database**: MongoDB
- **AI Integration**: OpenAI ChatGPT API

### **Bot Identity**
- **Name**: EKO
- **Purpose**: Conversational psychological assistant
- **Interaction Style**: Similar to ChatGPT with supportive responses

## üöÄ **Phase 1: Core Chat APIs (Current Focus)**

### **Required Endpoints**

#### **Chat Management**
1. **Create New Chat** - `POST /chat/create`
2. **Delete Specific Chat** - `DELETE /chat/{chat_id}`
3. **Delete All User Chats** - `DELETE /chat/all`
4. **Get Chat Suggestions** - `GET /chat/suggestions`
5. **Get Saved Chats** - `GET /chat/saved`

#### **Message Management**
6. **Get Conversation Messages** - `GET /chat/{chat_id}/messages`
7. **Send Message to Bot** - `POST /chat/{chat_id}/message`
8. **Update Message** - `PUT /message/{message_id}`
9. **Delete Message** - `DELETE /message/{message_id}`

## üèóÔ∏è **Implementation Plan**

### **Step 1: Database Schema Design**

#### **Chat Collection Structure**
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId", // Reference to users collection
  "name": "string", // Auto-generated by LLM or user-defined
  "isAutoNamed": "boolean", // True if name was generated by LLM
  "status": "string", // "active", "archived", "deleted"
  "createdAt": "datetime",
  "updatedAt": "datetime",
  "lastMessageAt": "datetime", // For sorting by recent activity
  "messageCount": "number", // Total messages in chat
  "isDeleted": "boolean" // Soft delete flag
}
```

#### **Message Collection Structure** (Implemented)
```json
{
  "_id": "ObjectId",
  "chatId": "ObjectId", // Reference to chats collection
  "userId": "ObjectId", // Reference to users collection
  "sender": "string", // "user", "bot", "system"
  "message": "string", // Message content
  "pictures": ["array"], // Array of picture URLs
  "voices": ["array"], // Array of voice URLs
  "timestamp": "datetime",
  "isDeleted": "boolean",
  "updatedAt": "datetime"
}
```

### **Step 2: Model Implementation**

#### **Chat Model** (`models/chat.py`)
- `ChatModel` - Database model
- `ChatResponse` - API response model
- `CreateChatRequest` - Request validation
- `DeleteChatRequest` - Request validation

#### **Message Model** (`models/message.py`)
- `MessageModel` - Database model
- `MessageResponse` - API response model
- `SendMessageRequest` - Request validation
- `UpdateMessageRequest` - Request validation
- `ConversationResponse` - Paginated conversation response

### **Step 3: Controller Implementation**

#### **Chat Controller** (`controllers/chat_controller.py`)
- `create_chat()` - Create new chat with title and description
- `delete_chat()` - Delete specific chat (soft delete)
- `delete_all_chats()` - Delete all user chats (soft delete)
- `get_chat_suggestions()` - Get predefined chat suggestions
- `get_saved_chats()` - Get user's saved chat conversations

#### **Message Controller** (`controllers/message_controller.py`)
- `get_conversation_messages()` - Get paginated conversation history
- `send_message()` - Send message to EKO bot and get response
- `update_message()` - Update specific message content
- `delete_message()` - Delete specific message (soft delete)
- `_generate_bot_response()` - Generate EKO bot response using OpenAI

### **Step 4: Route Implementation**

#### **Chat Routes** (`routes/chat.py`)
- `GET /chat/suggestions` - Get chat suggestion options
- `GET /chat/saved` - Get user's saved chats
- `POST /chat/create` - Create new chat
- `DELETE /chat/{chat_id}` - Delete specific chat
- `DELETE /chat/all` - Delete all user chats

#### **Message Routes** (`routes/chat.py` and `routes/message.py`)
- `GET /chat/{chat_id}/messages` - Get conversation with pagination
- `POST /chat/{chat_id}/message` - Send message to EKO bot
- `PUT /message/{message_id}` - Update specific message
- `DELETE /message/{message_id}` - Delete specific message

### **Step 5: OpenAI Integration**

#### **OpenAI Service** (`services/openai.py`)
- Chat name generation using ChatGPT API
- EKO bot response generation with psychological assistant personality
- Multilingual support (English/French) for bot responses
- Conversation context awareness
- Fallback responses when API fails
- Environment variable configuration

## üîß **Technical Requirements**

### **Dependencies**
- Add `openai` package to `requirements.txt`
- Environment variable: `OPENAI_API_KEY`

### **Database Indexes**
```javascript
// Chats collection indexes
db.chats.createIndex({ "userId": 1, "isDeleted": 1 })
db.chats.createIndex({ "userId": 1, "lastMessageAt": -1 })
db.chats.createIndex({ "status": 1 })

// Messages collection indexes
db.messages.createIndex({ "chatId": 1, "isDeleted": 1 })
db.messages.createIndex({ "chatId": 1, "timestamp": -1 })
db.messages.createIndex({ "userId": 1 })
db.messages.createIndex({ "sender": 1 })
```

### **Authentication**
- All endpoints require JWT authentication
- Extract `user_id` from JWT token
- Validate user exists and is active

### **Error Handling**
- Standardized error responses using existing error handler
- Multilingual support (English/French)
- Proper HTTP status codes

## üìä **API Specifications**

### **Chat Management APIs**

#### **1. Get Chat Suggestions**
```http
GET /chat/suggestions
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "Chat suggestions retrieved successfully",
  "data": [
    {"title": "Help with coding", "value": "coding_help"},
    {"title": "Mental health support", "value": "mental_health"},
    {"title": "General conversation", "value": "general_chat"}
  ]
}
```

#### **2. Get Saved Chats**
```http
GET /chat/saved
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "Saved chats retrieved successfully",
  "data": [
    {
      "chat_id": "string",
      "title": "string",
      "short_description": "string"
    }
  ]
}
```

#### **3. Create New Chat**
```http
POST /chat/create
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "title": "New Programming Discussion",
  "short_description": "Help with JavaScript concepts",
  "is_temporary": false
}
```

**Response:**
```json
{
  "success": true,
  "message": "Chat created successfully",
  "data": {
    "chatId": "string",
    "title": "string",
    "short_description": "string",
    "is_temporary": boolean,
    "createdAt": "datetime",
    "messageCount": 0
  }
}
```

#### **4. Delete Specific Chat**
```http
DELETE /chat/{chat_id}
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "Chat deleted successfully",
  "data": {
    "chatId": "string",
    "deletedAt": "datetime"
  }
}
```

#### **5. Delete All User Chats**
```http
DELETE /chat/all
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "All chats deleted successfully",
  "data": {
    "deletedCount": number,
    "deletedAt": "datetime"
  }
}
```

### **Message Management APIs**

#### **6. Get Conversation Messages**
```http
GET /chat/{chat_id}/messages?page=1&limit=20
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "Conversation retrieved successfully",
  "data": {
    "messages": [
      {
        "messageId": "string",
        "chatId": "string",
        "userId": "string",
        "sender": "user|bot",
        "message": "string",
        "pictures": ["array"],
        "voices": ["array"],
        "timestamp": "datetime"
      }
    ],
    "pagination": {
      "current_page": 1,
      "total_pages": 5,
      "total_messages": 100,
      "has_next": true
    }
  }
}
```

#### **7. Send Message to EKO Bot**
```http
POST /chat/{chat_id}/message
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "message": "Hello EKO, I am feeling stressed today. Can you help me?",
  "pictures": [],
  "voices": []
}
```

**Response:**
```json
{
  "success": true,
  "message": "Message sent successfully",
  "data": {
    "messageId": "string",
    "chatId": "string",
    "sender": "user",
    "message": "string",
    "pictures": ["array"],
    "voices": ["array"],
    "timestamp": "datetime",
    "bot_response": {
      "messageId": "string",
      "chatId": "string",
      "sender": "bot",
      "message": "Of course, I'm here to help. I'm sorry to hear you're feeling stressed...",
      "pictures": [],
      "voices": [],
      "timestamp": "datetime"
    }
  }
}
```

#### **8. Update Message**
```http
PUT /message/{message_id}
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "message": "Updated message content",
  "pictures": ["new_image_url"],
  "voices": ["new_voice_url"]
}
```

**Response:**
```json
{
  "success": true,
  "message": "Message updated successfully",
  "data": {
    "messageId": "string",
    "updated_message": "string",
    "pictures": ["array"],
    "voices": ["array"],
    "updated_at": "datetime"
  }
}
```

#### **9. Delete Message**
```http
DELETE /message/{message_id}
Authorization: Bearer <jwt_token>
```

**Response:**
```json
{
  "success": true,
  "message": "Message deleted successfully",
  "data": {
    "deleted_message_id": "string"
  }
}
```

## ü§ñ **EKO Bot Implementation**

### **Bot Personality & Characteristics**
- **Empathetic & Supportive** - Provides emotional support and validation
- **Non-judgmental** - Creates safe space for users to express themselves
- **Professional yet Warm** - Maintains therapeutic boundaries while being approachable
- **Conversational** - Responds naturally like a trusted friend
- **Context-Aware** - Remembers recent conversation history (last 10 messages)

### **Multilingual Support**
- **English Responses** - Natural, supportive English responses
- **French Responses** - Culturally appropriate French responses
- **Language Detection** - Uses user's stored language preference

### **Technical Features**
- **OpenAI GPT-3.5-turbo** integration for intelligent responses
- **Conversation Context** - Last 10 messages for context awareness
- **Fallback System** - Graceful degradation when OpenAI API fails
- **Response Timeout** - 30-second timeout for API calls
- **Psychological Focus** - Specialized prompts for mental health support

### **System Prompts**

#### **English Prompt**
```
You are EKO, a conversational psychological assistant. You are here to provide emotional support, gentle guidance, and a listening ear.

EKO's characteristics:
- You are empathetic, understanding, and non-judgmental
- You encourage expression of emotions and thoughts
- You provide practical advice for mental well-being
- You remain professional while being warm and approachable
- You ask thoughtful questions to better understand
- You offer relaxation and stress management techniques

Respond naturally and conversationally, as if speaking to a trusted friend. Keep your responses concise but meaningful.
```

#### **French Prompt**
```
Tu es EKO, un assistant psychologique conversationnel. Tu es l√† pour fournir un soutien √©motionnel, des conseils bienveillants et une √©coute attentive.

Caract√©ristiques d'EKO:
- Tu es empathique, compr√©hensif et non-jugeant
- Tu encourages l'expression des √©motions et des pens√©es
- Tu fournis des conseils pratiques pour le bien-√™tre mental
- Tu restes professionnel tout en √©tant chaleureux
- Tu poses des questions r√©fl√©chies pour mieux comprendre
- Tu offres des techniques de relaxation et de gestion du stress

R√©ponds de mani√®re naturelle et conversationnelle, comme si tu parlais √† un ami de confiance. Garde tes r√©ponses concises mais significatives.
```

## üîó **Integration Points**

### **Existing Systems**
- **Authentication**: Firebase + JWT middleware
- **Database**: MongoDB with existing patterns
- **Error Handling**: Standardized error responses
- **Localization**: English/French support
- **Docker**: All development in Docker containers

### **Future Integrations**
- **Message Storage**: When implementing chat history
- **Real-time Updates**: WebSocket integration
- **Voice Interface**: Audio message processing
- **Analytics**: Chat usage tracking

## üìù **Implementation Checklist**

### **Phase 1 (Completed)**
- [x] Create chat model and schemas
- [x] Implement chat controller with all methods
- [x] Create chat routes and integrate with app
- [x] Add OpenAI service for name generation
- [x] Update database.py with chat collection
- [x] Add required dependencies
- [x] Test all chat endpoints

### **Phase 2 (Completed)**
- [x] Implement message model and database collection
- [x] Implement message controller with full CRUD operations
- [x] Create message routes and integrate with app
- [x] Implement EKO bot response generation
- [x] Add conversation context awareness
- [x] Implement pagination for conversation history
- [x] Add multilingual support for bot responses
- [x] Test all message endpoints

### **Phase 3 (Future)**
- [ ] Implement file upload for message assets
- [ ] Add user insights endpoint
- [ ] Implement real-time chat functionality (WebSockets)
- [ ] Add chat search and filtering
- [ ] Implement chat archiving
- [ ] Add message reactions and emojis

## üéØ **Success Criteria**

### **Phase 1 Complete When:**
- ‚úÖ All 5 chat APIs working
- ‚úÖ OpenAI integration functional
- ‚úÖ Proper error handling and validation
- ‚úÖ Database indexes created
- ‚úÖ Authentication working
- ‚úÖ Multilingual support
- ‚úÖ Docker deployment ready

### **Phase 2 Complete When:**
- ‚úÖ All 4 message APIs working
- ‚úÖ EKO bot response generation functional
- ‚úÖ Conversation context awareness working
- ‚úÖ Pagination for message history
- ‚úÖ Multilingual bot responses
- ‚úÖ Message CRUD operations working
- ‚úÖ Database indexes for messages created

### **Testing Requirements**
- Unit tests for all controller methods
- Integration tests for API endpoints
- Error scenario testing
- OpenAI fallback testing
- Authentication testing
- Bot response quality testing
- Conversation context testing

## üìö **Related Files**

### **New Files Created**
- `models/chat.py` - Chat data models
- `models/message.py` - Message data models
- `controllers/chat_controller.py` - Chat business logic
- `controllers/message_controller.py` - Message business logic
- `routes/chat.py` - Chat API routes
- `routes/message.py` - Message API routes
- `services/openai.py` - OpenAI integration

### **Files Modified**
- `app.py` - Include chat and message routers
- `database.py` - Add chat and message collections with indexes
- `requirements.txt` - Add OpenAI dependency
- `locales/en.json` - Add chat and message messages
- `locales/fr.json` - Add French chat and message messages

---

**Status**: ‚úÖ **COMPLETED**
**Priority**: High
**Estimated Time**: 8-10 hours (Completed)
**Dependencies**: OpenAI API key, existing auth system

## üéâ **Implementation Summary**

### **‚úÖ Completed Features**
1. **Complete Chat Management System** - Create, read, delete chats with suggestions
2. **Full Message System** - Send, receive, update, delete messages with pagination
3. **EKO Bot Integration** - Intelligent psychological assistant with OpenAI
4. **Multilingual Support** - English and French responses
5. **Database Optimization** - Proper indexes for performance
6. **Authentication & Security** - JWT-based user authentication
7. **Error Handling** - Comprehensive error responses
8. **API Documentation** - Complete Swagger-compliant endpoints

### **üöÄ Ready for Frontend Integration**
The EKO chat system is now fully functional and ready for the mobile app team to integrate. All endpoints are tested and working correctly with proper authentication and error handling.
